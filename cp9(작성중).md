
## 0. 고가용성

> 고가용성 : 시스템이 장애 없이 정상적으로 수행하는 능력

- 레디스는 인메모리 DB
	- 모든 데이터는 메모리에서 관리되며, 따로 백업하지 않으면 인스턴스 재시작시 레디스 데이터는 휘발됨
	- 복제복을 구성하면 마스터에 장애가 발생한 경우에도 데이터는 복제 노드에 남이있을순 있음
- 만약 레디스의 고가용성이 보장되지 않았다면...
```
1. 마스터 서버에 장애 발생시, 복제본 노드에 접속하여 REPLICA OF NO ONE 커맨드를 입력해 읽기 전용 상태 해제
2. 어플리케이션 코드에서 레디스의 엔드 포인트를 복제본의 IP로 변경
3. 배포
```
- 별 다른 고가용성 기능의 도입 없이 위 과정을 거쳐 레디스를 사용한다면, 마스터에 장애가 발생할 때 마다 서비스 지연을 야기함
	- 마찬가지로 레디스의 look aside 기능도 주의해야 함
	- look aside는 레디스 마스터에서 캐시를 못읽어오는 상황이면 원본 DB에 직접 접근하기 때문
	- 급작스런 DB Connection 증가는 서비스에 악영향

결론적으로 고가용성을 어떻게 보장할 것인지가 중요하다.

<br/>
<br/>


## 1. 센티널이란?

> Sentinel : 보초병, 감시병

- 레디스의 자체 고가용성
- 데이터를 저장하는 기존 레디스의 인스턴스와는 별도의 프로그램
- 센티널의 자동 페일오버 기능을 사용하면 마스터 인스턴스에 장애가 발생해도 레디스를 계속 사용할 수 있음
	- 레디스의 다운타임을 최소화하도록 유도

#### (1) 센티널의 기능
- 모니터링 : 마스터, 복제본의 인스턴스 상태를 실시간으로 확인
- 자동 페일오버 : 마스터의 비정상 상태를 감지해 정상 상태의 복제본 노드를 마스터로 승경 시킴
	- 기존 마스터에 연결된 다른 복제본들도 새롭게 승격된 마스터에 연결됨
- 인스턴스 구성 정보 안내 : 페일 오버가 발생하면 변경된 마스터의 정보를 클라이언트에게 재전달하기 때문에 레디스의 엔드포인트를 바꿀 필요가 없음

![image](https://github.com/user-attachments/assets/8969f667-7db8-48b8-a92c-93897c53fe60)


<br/>
<br/>

#### (2) 센티널은 분산시스템으로 동작한다
- SPOF(Single Point Of Failure)는 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점 (= 문제의 원흉)
- 복제와 자동 페일오버로 고가용성을 확보하는 이유는 레디스가 SPOF가 되는 것을 방지하기 위함
- 센티널은 그 자체로 SPOF가 되는 것을 방지하기 위해 최소 3대 이상일 때 정상적으로 동작할 수 있도록 설계됨
	- 1번 이미지를 보면 센티널은 3대
	- 하나의 센티널에서 이슈가 생겨도 다른 센티널이 바톤 터치로 업무 진행
- 오탐을 줄이기 위해 센티널은 쿼럼(Quorum)이라는 개념 사용
	- 마스터가 비정상 동작을 한다는 것에 동의해야하는 센티널의 수
	- 일반적으로 센티널이 3대면 쿼럼은 2이며, 최소 2대의 센티널이 동의해야 페일오버 프로세스 수행
	- 쿼럼은 보통 홀수로 구성 (무승부를 막기 위함)


<br/>
<br/>

#### (3) 센티널 인스턴스 배치 방법
![image](https://github.com/user-attachments/assets/d95d4a43-a067-4ee0-8750-0cbe2dfc9b1e)

- 센티널 인스턴스는 물리적으로 서로 영향받지 않는 서버에서 실행되는 것이 좋음
	- 마스터의 장애를 감지할 수 있어야 하기 때문에 서로 다른 가용영역에 배치
- 2번과 같은 구조가 일반적인 구조 (3개 모두 각각 다른 서버에 위치)
	- 만약 host1의 마스터 서버에 문제가 생기면 host2, 3에 있는 인스턴스가 마스터 인스턴스에 접근이 불가능한 상태라는 것을 동의 한 뒤 페일오버를 진행시켜 host3, 또는 host3의 Replica가 Master로 승격됨

![image](https://github.com/user-attachments/assets/2b14e89c-d8ec-4a40-a8eb-22bc80be5f12)
- 기존 마스터를 바라보고 있던 클라이언트는 모두 host2를 바라보고 연결됨
- 만약 host1이 복구된다면 host1은 Replica로 host2를 바라보고 연결됨


~258p

---

- [wiki.linphone.org - Redis 고가용성의 배치 방법](https://wiki.linphone.org/xwiki/wiki/public/view/Flexisip/HOWTOs/High%20availability/)
